name: Code Coverage

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
    
    - name: Install dependencies
      run: go mod download
    
    - name: Install migrate tool
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ migrate
        MIGRATE_TMP_DIR=$(mktemp -d)
        cd $MIGRATE_TMP_DIR
        
        # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¸ Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ migrate Ð²Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
        curl -L https://github.com/golang-migrate/migrate/releases/download/v4.17.0/migrate.linux-amd64.tar.gz | tar xvz
        
        # ÐŸÐµÑ€ÐµÐ¼ÐµÑ‰Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» migrate
        sudo mv migrate /usr/local/bin/migrate
        
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
        cd -
        rm -rf $MIGRATE_TMP_DIR
    
    - name: Run migrations
      run: |
        migrate -path migrations -database "postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable" -verbose up
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_NAME: postgres
    
    - name: Run tests with coverage
      run: |
        go test -tags integration -coverprofile=coverage.out -covermode=atomic ./...
        go tool cover -func=coverage.out
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ
        echo "COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//g')" >> $GITHUB_ENV
        
        # Ð¢Ð°ÐºÐ¶Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¿Ð¾ Ð¿Ð°ÐºÐµÑ‚Ð°Ð¼
        go tool cover -func=coverage.out > coverage-details.txt
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_NAME: postgres
    
    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ†Ð²ÐµÑ‚ Ð´Ð»Ñ Ð±ÐµÐ¹Ð´Ð¶Ð°
    - name: Set badge color
      run: |
        if (( $(echo "${{ env.COVERAGE }} >= 80" | bc -l) )); then
          echo "BADGE_COLOR=brightgreen" >> $GITHUB_ENV
        elif (( $(echo "${{ env.COVERAGE }} >= 60" | bc -l) )); then
          echo "BADGE_COLOR=yellow" >> $GITHUB_ENV
        elif (( $(echo "${{ env.COVERAGE }} >= 40" | bc -l) )); then
          echo "BADGE_COLOR=orange" >> $GITHUB_ENV
        else
          echo "BADGE_COLOR=red" >> $GITHUB_ENV
        fi
    
    # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ README Ñ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¼ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð¾Ð¼ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ master)
    - name: Update README with coverage badge
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      run: |
        # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ñ Ð±ÐµÐ¹Ð´Ð¶ÐµÐ¼ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ Ð±Ð¾Ð»ÐµÐµ Ð½Ð°Ð´Ñ‘Ð¶Ð½Ñ‹Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´
        sed -i "s|!\[Coverage\](https://img.shields.io/badge/coverage-[0-9.]*%25-[a-z]*)|![Coverage](https://img.shields.io/badge/coverage-${{ env.COVERAGE }}%25-${{ env.BADGE_COLOR }})|g" README.md
        
        # ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ
        if git diff --quiet README.md; then
          echo "No changes to commit"
        else
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "Update coverage badge to ${{ env.COVERAGE }}%"
          git push
        fi
    
    # Ð”Ð»Ñ master ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð² Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚
    - name: Save coverage for master
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      run: echo "${{ env.COVERAGE }}" > master-coverage.txt
    
    - name: Upload master coverage
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: master-coverage
        path: master-coverage.txt
        retention-days: 90
    
    # Ð”Ð»Ñ PR Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ master Ð¸ ÑÑ€Ð°Ð²Ð½Ð¸Ð²Ð°ÐµÐ¼
    - name: Download master coverage
      if: github.event_name == 'pull_request'
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: coverage.yml
        branch: master
        name: master-coverage
        path: ./
      continue-on-error: true
    
    - name: Compare coverage
      if: github.event_name == 'pull_request'
      run: |
        if [ -f master-coverage.txt ]; then
          MASTER_COVERAGE=$(cat master-coverage.txt)
          echo "Master coverage: $MASTER_COVERAGE%"
          echo "Current coverage: ${{ env.COVERAGE }}%"
          
          # Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ Ñ€Ð°Ð·Ð½Ð¸Ñ†Ñƒ
          DIFF=$(echo "${{ env.COVERAGE }} - $MASTER_COVERAGE" | bc)
          
          # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ€Ð°Ð·Ð½Ð¸Ñ†Ñƒ Ñ Ð·Ð½Ð°ÐºÐ¾Ð¼
          if (( $(echo "$DIFF > 0" | bc -l) )); then
            DIFF_FORMATTED="+$DIFF"
          else
            DIFF_FORMATTED="$DIFF"
          fi
          
          # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
          if (( $(echo "$DIFF > 0" | bc -l) )); then
            EMOJI="ðŸ“ˆ"
            TREND="increased"
          elif (( $(echo "$DIFF < 0" | bc -l) )); then
            EMOJI="ðŸ“‰"
            TREND="decreased"
          else
            EMOJI="âž¡ï¸"
            TREND="remained the same"
          fi
          
          echo "COVERAGE_DIFF=$DIFF_FORMATTED" >> $GITHUB_ENV
          echo "COVERAGE_TREND=$TREND" >> $GITHUB_ENV
          echo "COVERAGE_EMOJI=$EMOJI" >> $GITHUB_ENV
          echo "MASTER_COVERAGE=$MASTER_COVERAGE" >> $GITHUB_ENV
        else
          echo "No master coverage data found"
          echo "COVERAGE_DIFF=N/A" >> $GITHUB_ENV
          echo "COVERAGE_TREND=unknown" >> $GITHUB_ENV
          echo "COVERAGE_EMOJI=â“" >> $GITHUB_ENV
          echo "MASTER_COVERAGE=N/A" >> $GITHUB_ENV
        fi
    
    # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ Ð²Ð¼ÐµÑÑ‚Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ CodeCoverageSummary
    - name: Generate coverage report
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸
        cat > code-coverage-results.md <<EOF
        ## Code Coverage: ${{ env.COVERAGE }}%
        
        <details>
        <summary>Coverage by package</summary>
        
        \`\`\`
        $(cat coverage-details.txt)
        \`\`\`
        
        </details>
        EOF
    
    # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ð´Ð»Ñ PR
    - name: Create coverage comment
      if: github.event_name == 'pull_request'
      run: |
        cat > coverage-comment.md <<EOF
        ## ðŸ“Š Code Coverage Report
        
        **Current Coverage:** ${{ env.COVERAGE }}% ${{ env.COVERAGE_EMOJI }}
        **Master Coverage:** ${{ env.MASTER_COVERAGE }}%
        **Difference:** ${{ env.COVERAGE_DIFF }}% (${{ env.COVERAGE_TREND }})
        
        ---
        
        EOF
        cat code-coverage-results.md >> coverage-comment.md
    
    - name: Add Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        recreate: true
        path: ${{ github.event_name == 'pull_request' && 'coverage-comment.md' || 'code-coverage-results.md' }}
    
    - name: Write to Job Summary
      run: |
        if [ -f coverage-comment.md ]; then
          cat coverage-comment.md >> $GITHUB_STEP_SUMMARY
        else
          cat code-coverage-results.md >> $GITHUB_STEP_SUMMARY
        fi
